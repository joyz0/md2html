
<h2 id="slug-slug-aa76f">åˆå§‹æ¸²æŸ“æºç è„‰ç»œ</h2>
<pre><code>// V17.0.0-alpha.0
â”œâ”€â”€ ReactDOM.render(&#x3C;App />, document.getElementById('root'))
  â”œâ”€â”€ legacyRenderSubtreeIntoContainer() => updateContainer()
    â”œâ”€â”€ enqueueUpdate(current, update) // å°†å¾…æ›´æ–°çš„å†…å®¹æŒ‚è½½åˆ°fiber.updateQueueä¸Š
    â”œâ”€â”€ scheduleUpdateOnFiber(current, lane, eventTime)ğŸŒˆ(1)
      â”œâ”€â”€ const root = markUpdateLaneFromFiberToRoot(fiber, lane) // å‘ä¸Šéå†æ›´æ–°å­èŠ‚ç‚¹çš„expiration timeï¼ŒV16 markUpdateTimeFromFiberToRoot
      â”œâ”€â”€ performSyncWorkOnRoot(root) // if: åŒæ­¥
        â”œâ”€â”€ renderRootSync(root, lanes) // âœ¨Render/Reconciliationé˜¶æ®µ
          â”œâ”€â”€ workLoopSync()
            â”œâ”€â”€ performUnitOfWork(workInProgress) // loop: workInProgress !== null
              â”œâ”€â”€ next = beginWork(current, unitOfWork, subtreeRenderLanes)
                â”œâ”€â”€ return mountIndeterminateComponent(current, workInProgress, workInProgress.type, renderLanes) // if: workInProgress.tag === IndeterminateComponent
                  â”œâ”€â”€ value = renderWithHooks(null, workInProgress, Component, props, context, renderLanes) // è¿”å›äº†ReactElement
                    â”œâ”€â”€ ReactCurrentDispatcher.current = HooksDispatcherOnMount // HooksDispatcherOnUpdate æŒ‚è½½useXXX
                    â”œâ”€â”€ let children = Component(props, secondArg) // âœ¨è°ƒç”¨renderå‡½æ•°ï¼ŒğŸ›å¾…æ¢ç´¢hooksé“¾è¡¨è¿‡ç¨‹ğŸŒˆ(2)
                    â”œâ”€â”€ ReactCurrentDispatcher.current = ContextOnlyDispatcher // é‡ç½®useXXX
                  â”œâ”€â”€ value = renderWithHooks(null, workInProgress, Component, props, context, renderLanes) // if: __DEV__ &#x26;&#x26; StrictMode é‡å¤æ‰§è¡Œrenderå‡½æ•°
                  â”œâ”€â”€ reconcileChildren(null, workInProgress, value, renderLanes) // âœ¨éå†åä»£èŠ‚ç‚¹ï¼Œä»value.props.childrenä¸­è·å¾—åä»£ä¿¡æ¯ï¼Œå†è¿æ¥åˆ°fiber.childä¸ŠğŸŒˆ(3)
                  â”œâ”€â”€ return workInProgress.child
                â”œâ”€â”€ return updateClassComponent() // if: workInProgress.tag === ClassComponent
                  â”œâ”€â”€ constructClassInstance(workInProgress, Component, nextProps)
                    â”œâ”€â”€ adoptClassInstance(workInProgress, instance)
                      â”œâ”€â”€ instance.updater = classComponentUpdater // åˆå§‹åŒ–updater
              â”œâ”€â”€ completeUnitOfWork(unitOfWork) // if: next === null è¯´æ˜å·²ç»åœ¨æœ€åº•å±‚çš„å­èŠ‚ç‚¹ï¼ŒğŸ›å¾…è°ƒè¯•æ¢ç´¢ï¼Œä¸performUnitOfWorkç›¸åæ ¹æ®fiber.returnå‘ä¸Šéå†ğŸŒˆ(4)
        â”œâ”€â”€ commitRoot(root) // âœ¨Commité˜¶æ®µï¼ŒğŸ›å¾…è°ƒè¯•æ¢ç´¢
          â”œâ”€â”€ commitRootImpl(root, renderPriorityLevel) // ğŸ›å¾—ä»”ç»†çœ‹ä¸‹runWithPriorityæ–¹æ³•ï¼Œæ¶‰åŠè°ƒåº¦
            â”œâ”€â”€ commitMutationEffects(finishedWork, root, renderPriorityLevel) // âœ¨å®Œæˆäº†domçš„æ›´æ–°ğŸŒˆ(5)
            â”œâ”€â”€ commitLayoutEffects(finishedWork, root, lanes) // âœ¨èµ‹å€¼refï¼Œè§¦å‘useLayoutEffectå›è°ƒå‡½æ•°
            â”œâ”€â”€ requestPaint() // å‘Šè¯‰Scheduleråœ¨å½“å‰æ¸²æŸ“å¸§æœ«å°¾è¿”è¿˜æ§åˆ¶æƒï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šæ¸²æŸ“ï¼ŒğŸ›å¾…æ¢ç´¢å¦‚ä½•å®ç°çš„
      â”œâ”€â”€ performConcurrentWorkOnRoot() // å¹¶å‘
</code></pre>
<h2 id="slug-slug-e5974">æ ‡è®°ç‚¹ ğŸŒˆ</h2>
<p>(1)ï¼šè§¦å‘æ¸²æŸ“ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§å°±æ˜¯ä¸Šé¢ç½—åˆ—çš„åˆå§‹åŒ–æ¸²æŸ“ï¼Œå¦ä¸€ç§å°±æ˜¯ setState çš„æ›´æ–°æ¸²æŸ“ï¼Œè¿™ä¸¤ç§æ–¹å¼ä»£ç å®ç°æœ‰é‡åˆéƒ¨åˆ†ï¼Œä»¥è¿™ä¸ªå‡½æ•°ä¸ºç•Œï¼Œä¹‹å‰ä¸åŒä¹‹åç›¸åŒï¼Œä¹‹å‰éƒ¨åˆ†å¦‚ä¸‹ï¼Œ</p>
<pre><code>// Class ç»„ä»¶
â”œâ”€â”€ this.setState() // å³this.updater.enqueueSetState
  â”œâ”€â”€ enqueueUpdate(fiber, update) // å°†å¾…æ›´æ–°çš„å†…å®¹æŒ‚è½½åˆ°fiber.updateQueueä¸Š
  â”œâ”€â”€ scheduleUpdateOnFiber(fiber, lane, eventTime)
// Hooks ç»„ä»¶
â”œâ”€â”€ const [_, setState] = useState()
â”œâ”€â”€ setState() // å³ReactFiberHooks.jsä¸­çš„dispatchAction
  â”œâ”€â”€ scheduleUpdateOnFiber(fiber, lane, eventTime)
</code></pre>
<p>(2)ï¼šæ‰§è¡Œ render å‡½æ•°ï¼Œæ­¤æ—¶å°±ä¼šè°ƒç”¨ä½¿ç”¨åˆ°çš„ hooksï¼Œè€Œ useXXX å†…éƒ¨ä¼šé€šè¿‡ mountWorkInProgressHook å°† hooks æŒ‰è°ƒç”¨æ¬¡åºæŒ‚è½½åˆ° workInProgressHook é“¾è¡¨ä¸Šï¼Œå¹¶å­˜å‚¨åˆ° currentlyRenderingFiber.memoizedState ä¸Šï¼Œrender å‡½æ•°æ‰§è¡Œå®Œæ¯•åä¼šæ¸…ç©º workInProgressHook é“¾è¡¨ä»¥å¤‡ä¸‹ä¸€æ¬¡æ¸²æŸ“ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œ render å‡½æ•°æ—¶é€šè¿‡ updateWorkInProgressHook ä¾æ¬¡ä» currentlyRenderingFiber.memoizedState è·å– hookã€‚</p>
<p>(3)ï¼šä¹‹å‰é€šè¿‡ render å‡½æ•°åˆ›å»ºäº† ReactElement å¯¹è±¡ï¼Œæ•´ä¸ªç»„ä»¶æ ‘æ˜¯é€šè¿‡ props.children è¿ç»“çš„ï¼ŒreconcileChildren åˆ™ä¼šæ ¹æ®æ­¤è½¬åŒ–ä¸º fiber é“¾è¡¨ã€‚</p>
<p>(4)ï¼šä¸ beginWork ç›¸åï¼ŒcompleteWork æ˜¯ä»å¶å­èŠ‚ç‚¹å‘ root èŠ‚ç‚¹éå†ï¼Œåº”è¯¥æ˜¯å› ä¸º passive effect ä¼šå½±å“åˆ°çˆ¶ç¥–èŠ‚ç‚¹ï¼Œæ‰€ä»¥åå‘å°†è¿™äº› effect æ›´æ–°åˆ°çˆ¶ç¥–èŠ‚ç‚¹ä¸Šã€‚</p>
<p>(5)ï¼šè¿™é‡Œä¼šè°ƒç”¨ç›¸å…³ dom api å°†æ­¤æ¬¡æ¸²æŸ“çš„å˜åŠ¨æ›´æ–°åˆ° dom æ ‘ä¸Šã€‚</p>
<h2 id="slug-slug-2393a">æ€»ç»“</h2>
<ul>
  <li>åœ¨ä¸€æ£µæ¸²æŸ“æ ‘ï¼Œå…¨å±€æ€§æ•°æ®éƒ½ä¼šå­˜å‚¨åœ¨ fiberRoot ä¸Šï¼Œè¿™ä¹Ÿæ˜¯åˆå§‹åŒ–æ¸²æŸ“ä¼šåˆ›å»º fiberRoot çš„åŸå› ä¹‹ä¸€å§ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾ç‰‡ã€‚</li>
</ul>
<p>
  <img src="/bimgs/react_dom_render.png">
</p>
<ul>
  <li>
    <p>useLayoutEffect çš„å›è°ƒå‡½æ•°æ˜¯åœ¨ commitLayoutEffects é˜¶æ®µè°ƒç”¨çš„ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ° useEffect å›è°ƒå‡½æ•°æ˜¯ä½•æ—¶è°ƒç”¨çš„ï¼Œåº”è¯¥å’Œ scheduledHostCallback/workLoop/invokeGuardedCallback è¿™å‡ ä¸ªå‡½æ•°æœ‰å…³ï¼Œäº¤ç”± BOM API æ‰§è¡Œäº†ï¼Œæºç æ¶‰åŠåˆ° scheduleï¼Œæœ‰ç‚¹çœ‹ä¸æ‡‚ã€‚</p>
  </li>
  <li>
    <p>ä¸€æ¬¡æ¸²æŸ“æ•´ä½“åˆ†ä¸º Render/Reconciliation å’Œ Commit ä¸¤ä¸ªé˜¶æ®µï¼Œå‰è€…ä»»åŠ¡è¢«åˆ†ç‰‡å¯ä»¥è¢«æ‰“æ–­ï¼Œåè€…ä¸€æ°”å‘µæˆä¼šé˜»å¡æµè§ˆå™¨æ¸²æŸ“ä¸»çº¿ç¨‹ã€‚</p>
  </li>
  <li>
    <p>ä¸å»ºè®®åœ¨ hooks deps ä½¿ç”¨ ref è·å–çš„ domï¼Œæ¯”å¦‚<code>useEffect(_, [ref.current])</code>ï¼Œå› ä¸º ref çš„èµ‹å€¼æ˜¯å»¶åçš„ï¼ˆåœ¨ Commit é˜¶æ®µï¼‰ï¼Œåœ¨ ref æ”¹å˜å‰ render å‡½æ•°å·²ç»è¢«æ‰§è¡Œã€‚å½“éœ€è¦å®æ—¶æµ‹é‡ dom çš„å˜åŒ–ï¼Œåº”è¯¥ä½¿ç”¨ functional refï¼Œè¿™ä¼šåœ¨ Commit é˜¶æ®µèµ‹å€¼æ—¶ç«‹å³è¢«è°ƒç”¨ã€‚</p>
  </li>
</ul>
